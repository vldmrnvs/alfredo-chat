import { useChatStore } from '../store/store';
import { triggerCelebration } from '../utils/confetti';

/**
 * Chat Service - Manages the conversational flow for Alfredo Cons√≥rcios
 * 
 * Flow Overview (16 Steps):
 * 0. Confirm Value
 * 1. Usage/Goal
 * 2. Urgency
 * 3-5. Strategic Questions (NEW)
 * 6. Lance
 * 7. Lance Value
 * 8. Show Strategies
 * 9. Name
 * 10. WhatsApp
 * 11. CPF
 * 12. Checkout Confirmation
 * 13. Pix Payment
 * 14. Docs Upload
 * 15. Checkin Form
 * 16. Success
 */

// ============================================================================
// TYPES
// ============================================================================

type StepAction = 'next' | 'wait' | 'jump';

interface Step {
    id: number;
    ask: () => Promise<void>;
    process: (value: string) => Promise<{ action: StepAction; target?: number }>;
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Validates Brazilian phone number format
 * @param phone - Phone string (can include formatting)
 * @returns true if valid (10-11 digits)
 */
const isValidPhone = (phone: string): boolean => {
    const cleaned = phone.replace(/\D/g, '');
    return cleaned.length >= 10 && cleaned.length <= 11;
};

/**
 * Validates Brazilian CPF using official algorithm
 * @param cpf - CPF string (can include formatting)
 * @returns true if valid CPF
 */
const isValidCPF = (cpf: string): boolean => {
    const cleaned = cpf.replace(/[^\d]+/g, '');
    if (cleaned === '' || cleaned.length !== 11 || /^(\d)\1+$/.test(cleaned)) return false;

    let add = 0;
    for (let i = 0; i < 9; i++) add += parseInt(cleaned.charAt(i)) * (10 - i);
    let rev = 11 - (add % 11);
    if (rev === 10 || rev === 11) rev = 0;
    if (rev !== parseInt(cleaned.charAt(9))) return false;

    add = 0;
    for (let i = 0; i < 10; i++) add += parseInt(cleaned.charAt(i)) * (11 - i);
    rev = 11 - (add % 11);
    if (rev === 10 || rev === 11) rev = 0;
    if (rev !== parseInt(cleaned.charAt(10))) return false;

    return true;
};

/**
 * Mock AI analysis function (replace with real Gemini API call)
 */
const mockAiAnalysis = async (profile: any): Promise<string> => {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve(`‚ö° <b>An√°lise:</b> Para ${profile.goal} com urg√™ncia ${profile.urgency}, o mercado est√° favor√°vel para lances intermedi√°rios.`);
        }, 1500);
    });
};

// ============================================================================
// CHAT SERVICE
// ============================================================================

export const chatService = {
    /**
     * Initialize chat flow with welcome message
     */
    init: async () => {
        const { addMessage, userData } = useChatStore.getState();

        // Format value for display
        const valFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(userData.value);

        // Contextual message for budget-based simulations
        if (userData.isBudgetBased) {
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: `Entendi. Com or√ßamento de <b>${valFormatted}</b>, vou focar em <b>Longevidade</b> para maximizar seu cr√©dito.`,
                sender: 'bot'
            });
        } else {
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: `Recebi sua solicita√ß√£o de <b>${valFormatted}</b> para <b>${userData.goal}</b>.`,
                sender: 'bot'
            });
        }

        await chatService.botTyping();
        addMessage({
            type: 'text',
            content: "O valor est√° correto? Vou fazer algumas perguntas r√°pidas para calibrar sua estrat√©gia.",
            sender: 'bot'
        });

        // Show confirmation options
        useChatStore.setState({
            inputType: 'options',
            quickReplies: [
                { label: "‚úÖ Sim, Bora l√°", value: "sim" },
                { label: "‚úèÔ∏è Corrigir Valor", value: "corrigir" }
            ]
        } as any);
    },

    /**
     * Simulate bot typing indicator
     */
    botTyping: async (ms = 1200): Promise<void> => {
        const { setTyping } = useChatStore.getState();
        setTyping(true);
        return new Promise(resolve => setTimeout(() => {
            setTyping(false);
            resolve();
        }, ms));
    },

    /**
     * Process user input and advance through steps
     */
    processInput: async (value: string, label?: string) => {
        const state = useChatStore.getState();
        const { stepIndex, addMessage, setStepIndex } = state;

        // 1. Add User Message
        addMessage({ type: 'text', content: label || value, sender: 'user' });

        // 2. Clear Inputs
        useChatStore.setState({ inputType: 'hidden', quickReplies: [] } as any);

        // 3. Process Current Step
        const currentStep = steps[stepIndex];
        if (currentStep) {
            const result = await currentStep.process(value);

            if (result.action === 'next') {
                const nextIdx = stepIndex + 1;
                setStepIndex(nextIdx);
                if (steps[nextIdx]) {
                    await steps[nextIdx].ask();
                }
            } else if (result.action === 'jump') {
                const nextIdx = result.target!;
                setStepIndex(nextIdx);
                if (steps[nextIdx]) await steps[nextIdx].ask();
            }
            // 'wait' does nothing, stays on same step
        }
    }
};

// ============================================================================
// FLOW STEPS
// ============================================================================

const steps: Step[] = [
    // ------------------------------------------------------------------------
    // STEP 0: Confirm Value
    // ------------------------------------------------------------------------
    {
        id: 0,
        ask: async () => { }, // Handled in init
        process: async (v) => {
            const { addMessage, updateUserData } = useChatStore.getState();
            const lowerV = v.toLowerCase();

            // User wants to correct value
            if (lowerV.includes('corrigir') || lowerV.includes('nao') || lowerV.includes('n√£o')) {
                await chatService.botTyping();
                addMessage({ type: 'text', content: "Sem problemas. Qual o valor correto?", sender: 'bot' });
                useChatStore.setState({ inputType: 'currency' } as any);
                return { action: 'wait' };
            }

            // User confirms value
            if (lowerV.includes('sim') || lowerV.includes('bora') || lowerV.includes('ok')) {
                return { action: 'next' };
            }

            // Assume it's a corrected value input
            const cleanStr = v.replace(/[^\d,]/g, '').replace(',', '.');
            const numVal = parseFloat(cleanStr);

            if (!isNaN(numVal) && numVal > 0) {
                updateUserData({ value: numVal });
                return { action: 'next' };
            }

            // Invalid input
            await chatService.botTyping();
            addMessage({ type: 'text', content: "N√£o entendi o valor. Pode digitar novamente? (Ex: 300.000)", sender: 'bot' });
            return { action: 'wait' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 1: Usage/Goal
    // ------------------------------------------------------------------------
    {
        id: 1,
        ask: async () => {
            const { userData, addMessage } = useChatStore.getState();
            await chatService.botTyping();

            if (userData.goal === 'imovel') {
                addMessage({ type: 'text', content: "Qual o objetivo principal?", sender: 'bot' });
                useChatStore.setState({
                    inputType: 'options',
                    quickReplies: [
                        { label: "üè† Morar", value: "morar" },
                        { label: "üí∏ Investir", value: "investir" },
                        { label: "üèóÔ∏è Construir", value: "construir" }
                    ]
                } as any);
            } else {
                addMessage({ type: 'text', content: "Qual ser√° o uso?", sender: 'bot' });
                useChatStore.setState({
                    inputType: 'options',
                    quickReplies: [
                        { label: "üöó Pessoal", value: "pessoal" },
                        { label: "üíº Trabalho", value: "trabalho" },
                        { label: "üîÑ Troca", value: "troca" }
                    ]
                } as any);
            }
        },
        process: async (v) => {
            useChatStore.getState().updateUserData({ usage: v as any });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 2: Urgency
    // ------------------------------------------------------------------------
    {
        id: 2,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({ type: 'text', content: "Sobre pressa, qual sua realidade?", sender: 'bot' });
            useChatStore.setState({
                inputType: 'options',
                quickReplies: [
                    { label: "‚ö° Para Ontem", value: "imediata" },
                    { label: "üî• 3-6 Meses", value: "media" },
                    { label: "üìÖ Planejado", value: "longa" },
                    { label: "üí∞ Investimento", value: "investidor" }
                ]
            } as any);
        },
        process: async (v) => {
            useChatStore.getState().updateUserData({ urgency: v as any });
            return { action: 'next' };
        }
    },

    // ========================================================================
    // NEW STRATEGIC QUESTIONS (Steps 3-5)
    // ========================================================================

    // ------------------------------------------------------------------------
    // STEP 3: Estrategia de Acelera√ß√£o
    // ------------------------------------------------------------------------
    {
        id: 3,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: "Para aumentar suas chances de contempla√ß√£o, voc√™ prefere:",
                sender: 'bot'
            });
            useChatStore.setState({
                inputType: 'options',
                quickReplies: [
                    { label: "üí∞ Dar Entrada Maior", value: "entrada" },
                    { label: "üìÖ Pagar Parcelas Normais", value: "parcela" }
                ]
            } as any);
        },
        process: async (v) => {
            useChatStore.getState().updateUserData({ aceleracao_strategy: v as any });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 4: Prefer√™ncia de Parcelas
    // ------------------------------------------------------------------------
    {
        id: 4,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: "Enquanto aguarda a contempla√ß√£o, como prefere pagar as parcelas?",
                sender: 'bot'
            });
            useChatStore.setState({
                inputType: 'options',
                quickReplies: [
                    { label: "üìâ Menor Poss√≠vel", value: "menor" },
                    { label: "‚öñÔ∏è Valor Normal", value: "normal" },
                    { label: "üìà Maior (Acelera Contempla√ß√£o)", value: "maior" }
                ]
            } as any);
        },
        process: async (v) => {
            useChatStore.getState().updateUserData({ parcela_preference: v as any });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 5: Fundo de Reserva
    // ------------------------------------------------------------------------
    {
        id: 5,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: "Nos primeiros 2 meses h√° o fundo de reserva. Voc√™ prefere:",
                sender: 'bot'
            });
            useChatStore.setState({
                inputType: 'options',
                quickReplies: [
                    { label: "üíµ Entrada Maior + Parcelas Menores", value: "entrada_maior" },
                    { label: "üí≥ Entrada Menor + Parcelas Normais", value: "entrada_menor" }
                ]
            } as any);
        },
        process: async (v) => {
            useChatStore.getState().updateUserData({ fundo_reserva_preference: v as any });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 6: Lance (with "Como funciona?" option)
    // ------------------------------------------------------------------------
    {
        id: 6,
        ask: async () => {
            const { addMessage, userData } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: "Sobre <b>Acelera√ß√£o</b>. Voc√™ tem algum valor ou bem para dar de lance?",
                sender: 'bot'
            });

            const opts = [
                { label: "‚ùå N√£o tenho lance", value: "nada" },
                { label: "üí∞ Dinheiro (Recurso Pr√≥prio)", value: "dinheiro" }
            ];

            // Conditional options based on goal
            if (userData.goal === 'imovel') {
                opts.push({ label: "üè¶ FGTS", value: "fgts" });
            }
            opts.push({ label: "üöó Ve√≠culo", value: "carro" });

            // Add Im√≥vel option for auto/moto
            if (userData.goal !== 'imovel') {
                opts.push({ label: "üè† Im√≥vel", value: "imovel" });
            }

            // Educational option
            opts.push({ label: "ü§î Como funciona?", value: "explicar" });

            useChatStore.setState({ inputType: 'options', quickReplies: opts } as any);
        },
        process: async (v) => {
            const { addMessage, userData, updateUserData } = useChatStore.getState();

            // Educational flow
            if (v === 'explicar') {
                await chatService.botTyping();
                addMessage({
                    type: 'text',
                    content: "<b>Lance:</b> √â a chance de antecipar seu cr√©dito ofertando um valor. Quem oferta mais, leva antes.",
                    sender: 'bot'
                });
                await chatService.botTyping();
                addMessage({
                    type: 'text',
                    content: "Voc√™ pretende ofertar algo?",
                    sender: 'bot'
                });

                // Re-show options WITHOUT "Como funciona?"
                const opts = [
                    { label: "‚ùå N√£o vou ofertar", value: "nada" },
                    { label: "üí∞ Sim, Dinheiro", value: "dinheiro" }
                ];
                if (userData.goal === 'imovel') opts.push({ label: "üè¶ Sim, FGTS", value: "fgts" });
                opts.push({ label: "üöó Sim, Ve√≠culo", value: "carro" });
                if (userData.goal !== 'imovel') opts.push({ label: "üè† Sim, Im√≥vel", value: "imovel" });

                useChatStore.setState({ inputType: 'options', quickReplies: opts } as any);
                return { action: 'wait' };
            }

            // No lance - skip to strategies
            if (v === 'nada') {
                updateUserData({ has_lance: false, lance_type: 'nada' });
                return { action: 'jump', target: 8 }; // Skip lance value step
            }

            // Has lance - proceed to value input
            updateUserData({ has_lance: true, lance_type: v as any });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 7: Lance Value
    // ------------------------------------------------------------------------
    {
        id: 7,
        ask: async () => {
            const { addMessage, userData } = useChatStore.getState();
            await chatService.botTyping();

            let msg = "Qual o valor dispon√≠vel?";
            if (userData.lance_type === 'dinheiro') msg = "Qual valor voc√™ tem dispon√≠vel em dinheiro?";
            if (userData.lance_type === 'fgts') msg = "Qual o saldo aproximado do seu FGTS?";
            if (userData.lance_type === 'carro') msg = "Qual o valor de mercado do ve√≠culo?";
            if (userData.lance_type === 'imovel') msg = "Qual o valor de mercado do im√≥vel?";

            addMessage({ type: 'text', content: msg, sender: 'bot' });
            useChatStore.setState({ inputType: 'currency' } as any);
        },
        process: async (v) => {
            const val = parseFloat(v.replace(/\D/g, '')) / 100;
            useChatStore.getState().updateUserData({ lance_value: val });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 8: Show Strategies
    // ------------------------------------------------------------------------
    {
        id: 8,
        ask: async () => {
            const { addMessage, userData, setModalOpen } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: `‚ú® <i>Analisando grupos ativos para o perfil <b>${userData.goal}</b>...</i>`,
                sender: 'bot'
            });

            await chatService.botTyping(1500);
            const aiMsg = await mockAiAnalysis(userData);
            addMessage({ type: 'text', content: aiMsg, sender: 'bot' });

            await chatService.botTyping();
            addMessage({ type: 'text', content: "Encontrei estas 3 rotas vencedoras:", sender: 'bot' });

            // Show Strategy Cards
            addMessage({ type: 'card', content: 'strategies', sender: 'bot' });

            // Auto-open modal
            setTimeout(() => setModalOpen(true), 800);

            useChatStore.setState({ inputType: 'hidden' } as any);
        },
        process: async (v) => {
            const { userData, setModalOpen, addMessage } = useChatStore.getState();

            // Only advance if a route was selected
            if (userData.finalRoute) {
                return { action: 'next' };
            }

            // Re-prompt if no selection
            if (v !== 'internal_action') {
                await chatService.botTyping();
                addMessage({
                    type: 'text',
                    content: "Por favor, escolha uma das estrat√©gias acima para continuarmos.",
                    sender: 'bot'
                });
                setModalOpen(true);
            }

            return { action: 'wait' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 9: Name
    // ------------------------------------------------------------------------
    {
        id: 9,
        ask: async () => {
            const { addMessage } = useChatStore.getState();

            // Show proposal summary
            await chatService.botTyping();
            addMessage({ type: 'text', content: "Aqui est√° o resumo da estrat√©gia escolhida:", sender: 'bot' });
            addMessage({ type: 'card', content: 'proposal', sender: 'bot' });

            // Ask for name
            await chatService.botTyping(1500);
            addMessage({
                type: 'text',
                content: "√ìtima escolha! Para formalizar a proposta, qual seu nome completo?",
                sender: 'bot'
            });
            useChatStore.setState({ inputType: 'text' } as any);
        },
        process: async (v) => {
            useChatStore.getState().updateUserData({ name: v });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 10: WhatsApp (with validation)
    // ------------------------------------------------------------------------
    {
        id: 10,
        ask: async () => {
            const { addMessage, userData } = useChatStore.getState();
            await chatService.botTyping();
            const firstName = userData.name.split(' ')[0];
            addMessage({
                type: 'text',
                content: `Prazer, ${firstName}! Qual seu WhatsApp para eu enviar o PDF da proposta?`,
                sender: 'bot'
            });
            useChatStore.setState({ inputType: 'phone' } as any);
        },
        process: async (v) => {
            const { addMessage } = useChatStore.getState();

            // Validate phone
            if (!isValidPhone(v)) {
                await chatService.botTyping();
                addMessage({
                    type: 'text',
                    content: "‚ö†Ô∏è Telefone inv√°lido. Use o formato (XX) 9XXXX-XXXX.",
                    sender: 'bot'
                });
                useChatStore.setState({ inputType: 'phone' } as any);
                return { action: 'wait' };
            }

            useChatStore.getState().updateUserData({ whatsapp: v });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 11: CPF
    // ------------------------------------------------------------------------
    {
        id: 11,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: "CPF? (S√≥ para checar sua elegibilidade em ofertas rel√¢mpago).",
                sender: 'bot'
            });
            useChatStore.setState({ inputType: 'cpf' } as any);
        },
        process: async (v) => {
            const clean = v.replace(/\D/g, '');
            const { addMessage, updateUserData, userData } = useChatStore.getState();

            // Check length
            if (clean.length !== 11) {
                await chatService.botTyping();
                addMessage({
                    type: 'text',
                    content: "‚ö†Ô∏è O CPF precisa ter 11 d√≠gitos.",
                    sender: 'bot'
                });
                useChatStore.setState({ inputType: 'cpf' } as any);
                return { action: 'wait' };
            }

            // Validate CPF
            const tags = userData.tags || [];
            if (!isValidCPF(clean)) {
                await chatService.botTyping();
                addMessage({
                    type: 'text',
                    content: "‚ö†Ô∏è CPF n√£o verificado, mas vamos seguir com a simula√ß√£o. üöÄ",
                    sender: 'bot'
                });
                tags.push('CPF_INVALIDO');
            }

            updateUserData({ cpf: v, tags });
            return { action: 'next' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 12: Checkout Confirmation
    // ------------------------------------------------------------------------
    {
        id: 12,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: "Confirma os valores para gerarmos o contrato?",
                sender: 'bot'
            });

            useChatStore.setState({
                inputType: 'options',
                quickReplies: [
                    { label: "ü§ñ Sistema Autom√°tico", value: "pay" },
                    { label: "üë§ Falar com Humano", value: "human" }
                ]
            } as any);
        },
        process: async (v) => {
            if (v === 'pay') return { action: 'next' };

            if (v === 'human') {
                const { addMessage, userData } = useChatStore.getState();
                await chatService.botTyping();
                addMessage({
                    type: 'text',
                    content: "Entendi! Um de nossos especialistas vai te ajudar pessoalmente. Clique abaixo para chamar no WhatsApp:",
                    sender: 'bot'
                });

                const message = `Ol√°! Me chamo ${userData.name}. Estava na simula√ß√£o (R$ ${userData.value}) e gostaria de ajuda humana.`;
                const whatsappUrl = `https://wa.me/5511999999999?text=${encodeURIComponent(message)}`;

                addMessage({
                    type: 'text',
                    content: `<a href="${whatsappUrl}" target="_blank" class="underline font-bold text-green-600">üëâ Falar no WhatsApp</a>`,
                    sender: 'bot'
                });

                return { action: 'wait' };
            }

            return { action: 'wait' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 13: Pix Payment
    // ------------------------------------------------------------------------
    {
        id: 13,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({ type: 'text', content: "Gerando Pix para ades√£o...", sender: 'bot' });
            addMessage({ type: 'card', content: 'pix', sender: 'bot' });
            useChatStore.setState({ inputType: 'hidden' } as any);
        },
        process: async (v) => {
            if (v === 'paguei') {
                triggerCelebration();
                return { action: 'next' };
            }
            return { action: 'wait' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 14: Docs Upload
    // ------------------------------------------------------------------------
    {
        id: 14,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({ type: 'text', content: "Pagamento identificado! üöÄ Parab√©ns.", sender: 'bot' });
            await chatService.botTyping();
            addMessage({ type: 'text', content: "Para oficializar, preciso de uma foto do RG/CNH.", sender: 'bot' });
            addMessage({ type: 'card', content: 'docs', sender: 'bot' });
        },
        process: async (v) => {
            if (v === 'docs_uploaded') return { action: 'next' };
            return { action: 'wait' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 15: Checkin Form
    // ------------------------------------------------------------------------
    {
        id: 15,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            await chatService.botTyping();
            addMessage({
                type: 'text',
                content: "Recebido! Agora, por favor, s√≥ confirme seus dados pessoais abaixo para o contrato.",
                sender: 'bot'
            });
            addMessage({ type: 'card', content: 'checkin-form', sender: 'bot' });
        },
        process: async (v) => {
            if (v === 'form_completed') return { action: 'next' };
            return { action: 'wait' };
        }
    },

    // ------------------------------------------------------------------------
    // STEP 16: Success
    // ------------------------------------------------------------------------
    {
        id: 16,
        ask: async () => {
            const { addMessage } = useChatStore.getState();
            addMessage({ type: 'card', content: 'success', sender: 'bot' });
        },
        process: async () => {
            return { action: 'wait' };
        }
    }
];

// ============================================================================
// EXTERNAL HELPERS
// ============================================================================

/**
 * Advance flow from external components (Modal, Cards)
 */
export const advanceFlow = async (value?: string) => {
    const { stepIndex } = useChatStore.getState();
    const current = steps[stepIndex];
    if (current) {
        await chatService.processInput(value || 'internal_action', value);
    }
};
